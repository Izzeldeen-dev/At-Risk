<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>At-Risk Client Intervention Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-nav {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
        }

        .nav-tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tab:hover {
            background: #e9ecef;
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
        }

        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .card-body {
            padding: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
        }

        .rca-category-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .category-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-card:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .category-card.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .category-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .subcategory-list {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .subcategory-item {
            margin: 5px 0;
            padding: 3px 0;
        }

        .rca-recommendations {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }

        .action-recommendation {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            border-left: 3px solid #28a745;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .priority-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .priority-high {
            background: #ff4b2b;
            color: white;
        }

        .priority-medium {
            background: #ffa500;
            color: white;
        }

        .priority-low {
            background: #28a745;
            color: white;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1001;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #667eea, #764ba2);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            margin-left: 20px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -26px;
            top: 25px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #667eea;
            border: 3px solid white;
            box-shadow: 0 0 0 3px #667eea;
        }

        .timeline-date {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            font-size: 0.9rem;
            z-index: 1000;
        }

        .sync-online {
            color: #28a745;
        }

        .sync-offline {
            color: #dc3545;
        }

        .sync-syncing {
            color: #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® At-Risk Client Intervention Tool</h1>
            <p>Advanced RCA Framework for Client Recovery</p>
        </div>

        <div class="main-nav">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('rca')">RCA Analysis</button>
                <button class="nav-tab" onclick="showTab('action-plan')">Action Plans</button>
                <button class="nav-tab" onclick="showTab('tracking')">Progress Tracking</button>
            </div>

            <!-- RCA Analysis Tab -->
            <div id="rca" class="tab-content active">
                <div class="card">
                    <div class="card-header">
                        üîç Root Cause Analysis - Category Selection
                    </div>
                    <div class="card-body">
                        <p style="margin-bottom: 20px; color: #666;">Select the primary category that best describes the issues identified:</p>
                        
                        <div class="rca-category-selector">
                            <div class="category-card" onclick="selectRCACategory('internal')">
                                <div class="category-title">üè¢ Internal Factors</div>
                                <div class="subcategory-list">
                                    <div class="subcategory-item">‚Ä¢ Extra Services Request</div>
                                    <div class="subcategory-item">‚Ä¢ Well-Being</div>
                                    <div class="subcategory-item">‚Ä¢ Vacations</div>
                                    <div class="subcategory-item">‚Ä¢ Budget</div>
                                    <div class="subcategory-item">‚Ä¢ Account Manager Knowledge</div>
                                    <div class="subcategory-item">‚Ä¢ Editors Knowledge</div>
                                    <div class="subcategory-item">‚Ä¢ QC Procedures</div>
                                </div>
                            </div>

                            <div class="category-card" onclick="selectRCACategory('external')">
                                <div class="category-title">üåê External Factors</div>
                                <div class="subcategory-list">
                                    <div class="subcategory-item">‚Ä¢ Platform Bugs</div>
                                    <div class="subcategory-item">‚Ä¢ Financial Challenges</div>
                                </div>
                            </div>

                            <div class="category-card" onclick="selectRCACategory('relationships')">
                                <div class="category-title">ü§ù Relationships</div>
                                <div class="subcategory-list">
                                    <div class="subcategory-item">‚Ä¢ Conflict of Interest</div>
                                    <div class="subcategory-item">‚Ä¢ Values Alignment</div>
                                    <div class="subcategory-item">‚Ä¢ Communication (Soft Skills, Coaching, etc.)</div>
                                </div>
                            </div>

                            <div class="category-card" onclick="selectRCACategory('product')">
                                <div class="category-title">üé¨ Product Related Issues</div>
                                <div class="subcategory-list">
                                    <div class="subcategory-item">‚Ä¢ Video Mistakes (External Look, Wrong B-Rolls, QC Mistakes)</div>
                                    <div class="subcategory-item">‚Ä¢ Briefs</div>
                                    <div class="subcategory-item">‚Ä¢ Results (Client Performance)</div>
                                </div>
                            </div>
                        </div>

                        <div id="selectedCategoryInfo" style="display: none; margin-top: 20px;">
                            <div class="card" style="background: #f8f9fa; border: 1px solid #dee2e6;">
                                <div class="card-body" style="padding: 15px;">
                                    <h5>Selected Category: <span id="selectedCategoryName"></span></h5>
                                    <div class="form-group" style="margin-top: 15px;">
                                        <label>Specific Subcategory:</label>
                                        <select class="form-control" id="subcategorySelect" onchange="showRCARecommendations()">
                                            <option value="">Select specific issue...</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- RCA Recommendations -->
                        <div id="rcaRecommendations" class="rca-recommendations" style="display: none;">
                            <h5>üí° Recommended Actions for <span id="rcaCategory"></span>:</h5>
                            <div id="rcaActionRecommendations"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        üìù RCA Analysis Details
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Issue Description:</label>
                            <textarea class="form-control" id="issueDescription" rows="4" placeholder="Describe the specific issues identified in detail..."></textarea>
                        </div>

                        <div class="form-group">
                            <label>Contributing Factors:</label>
                            <textarea class="form-control" id="contributingFactors" rows="3" placeholder="List all contributing factors that led to this issue..."></textarea>
                        </div>

                        <div class="form-group">
                            <label>Action Plan:</label>
                            <textarea class="form-control" id="rcaActionPlan" rows="3" placeholder="What specific actions will be taken to address this issue?"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Priority Level:</label>
                            <select class="form-control" id="rcaPriority">
                                <option value="high">High - Immediate Action Required (24-48 hours)</option>
                                <option value="medium">Medium - Address within 1-2 weeks</option>
                                <option value="low">Low - Monitor and review monthly</option>
                            </select>
                        </div>

                        <button class="btn btn-success" onclick="saveRCAFindings()">Save RCA & Generate Action Plan</button>
                    </div>
                </div>
            </div>

            <!-- Action Plans Tab -->
            <div id="action-plan" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        üìã Generated Action Plans
                    </div>
                    <div class="card-body">
                        <div id="actionPlanContainer">
                            <p>Complete an RCA analysis to generate specific action plans.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Tracking Tab -->
            <div id="tracking" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        üìà RCA Progress Tracking
                    </div>
                    <div class="card-body">
                        <div id="rcaTrackingList">
                            <p>No active RCA items to track.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RCA Meeting Guide Modal -->
    <div id="rcaModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('rcaModal')">&times;</span>
            <h2>üîç RCA Meeting Guide</h2>
            <div class="timeline">
                <div class="timeline-item">
                    <div class="timeline-date">0-15 minutes</div>
                    <h4>Situation Overview</h4>
                    <p>Review current client health, recent interactions, and timeline of issues</p>
                </div>
                <div class="timeline-item">
                    <div class="timeline-date">15-45 minutes</div>
                    <h4>Root Cause Investigation</h4>
                    <p>Deep dive into selected category - analyze all contributing factors</p>
                </div>
                <div class="timeline-item">
                    <div class="timeline-date">45-60 minutes</div>
                    <h4>Action Planning</h4>
                    <p>Develop specific, measurable actions with clear ownership and timelines</p>
                </div>
                <div class="timeline-item">
                    <div class="timeline-date">60-70 minutes</div>
                    <h4>Follow-up Strategy</h4>
                    <p>Set review cadence, success metrics, and escalation triggers</p>
                </div>
            </div>
            <button class="btn btn-primary" onclick="closeModal('rcaModal')">Start Analysis</button>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="notification">
        <span id="notificationText">Action completed successfully!</span>
    </div>

    <!-- Sync Status -->
    <div id="syncStatus" class="sync-status">
        <span id="syncText">üîÑ Connecting...</span>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCBQF-5y5W_ucFRxSDwoiYneIVPGnkiXdg",
            authDomain: "at-risk-d3f6c.firebaseapp.com",
            databaseURL: "https://at-risk-d3f6c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "at-risk-d3f6c",
            storageBucket: "at-risk-d3f6c.firebasestorage.app",
            messagingSenderId: "286406637944",
            appId: "1:286406637944:web:e99f50c1e22221077b708d"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const rcaRef = database.ref('rca-findings');

        // Global variables
        let selectedCategory = null;
        let selectedSubcategory = null;
        let rcaFindings = [];
        let rcaListener = null;

        // RCA Category definitions with specific subcategories and recommendations
        const rcaCategories = {
            internal: {
                name: "Internal Factors",
                icon: "üè¢",
                subcategories: {
                    "extra-services": "Extra Services Request",
                    "wellbeing": "Well-Being",
                    "vacations": "Vacations",
                    "budget": "Budget",
                    "am-knowledge": "Account Manager Knowledge",
                    "editor-knowledge": "Editors Knowledge",
                    "qc-procedures": "QC Procedures"
                },
                recommendations: {
                    "extra-services": [
                        { action: "Review client's extra service requests and timeline", priority: "high" },
                        { action: "Assess resource allocation and capacity", priority: "medium" },
                        { action: "Create clear extra services pricing structure", priority: "medium" },
                        { action: "Set expectations on delivery timelines", priority: "high" }
                    ],
                    "wellbeing": [
                        { action: "Conduct team wellbeing assessment", priority: "high" },
                        { action: "Implement workload distribution review", priority: "medium" },
                        { action: "Schedule one-on-one check-ins with team", priority: "high" },
                        { action: "Review and adjust project deadlines if needed", priority: "medium" }
                    ],
                    "vacations": [
                        { action: "Review vacation coverage procedures", priority: "medium" },
                        { action: "Create backup team assignments", priority: "high" },
                        { action: "Implement vacation calendar visibility", priority: "low" },
                        { action: "Establish emergency contact protocols", priority: "medium" }
                    ],
                    "budget": [
                        { action: "Conduct budget variance analysis", priority: "high" },
                        { action: "Review project scope vs. budget allocation", priority: "high" },
                        { action: "Meet with finance to discuss budget adjustments", priority: "medium" },
                        { action: "Create cost optimization plan", priority: "medium" }
                    ],
                    "am-knowledge": [
                        { action: "Assess current Account Manager skill gaps", priority: "high" },
                        { action: "Provide targeted training on client's industry", priority: "high" },
                        { action: "Create knowledge sharing sessions", priority: "medium" },
                        { action: "Implement mentorship program", priority: "low" }
                    ],
                    "editor-knowledge": [
                        { action: "Review editor training materials", priority: "medium" },
                        { action: "Conduct skills assessment for editing team", priority: "high" },
                        { action: "Provide specialized training on client requirements", priority: "high" },
                        { action: "Create editing guidelines and standards", priority: "medium" }
                    ],
                    "qc-procedures": [
                        { action: "Audit current QC procedures", priority: "high" },
                        { action: "Implement additional QC checkpoints", priority: "high" },
                        { action: "Train QC team on client-specific requirements", priority: "medium" },
                        { action: "Create QC escalation procedures", priority: "medium" }
                    ]
                }
            },
            external: {
                name: "External Factors",
                icon: "üåê",
                subcategories: {
                    "platform-bugs": "Platform Bugs",
                    "financial-challenges": "Financial Challenges"
                },
                recommendations: {
                    "platform-bugs": [
                        { action: "Document all platform bugs affecting client", priority: "high" },
                        { action: "Escalate critical bugs to platform support", priority: "high" },
                        { action: "Create workaround solutions", priority: "medium" },
                        { action: "Provide regular updates to client on bug status", priority: "medium" }
                    ],
                    "financial-challenges": [
                        { action: "Assess client's financial situation impact", priority: "high" },
                        { action: "Explore flexible payment options", priority: "medium" },
                        { action: "Review contract terms for adjustments", priority: "medium" },
                        { action: "Provide ROI analysis and value demonstration", priority: "high" }
                    ]
                }
            },
            relationships: {
                name: "Relationships",
                icon: "ü§ù",
                subcategories: {
                    "conflict-interest": "Conflict of Interest",
                    "values-alignment": "Values Alignment",
                    "communication": "Communication (Soft Skills, Coaching, etc.)"
                },
                recommendations: {
                    "conflict-interest": [
                        { action: "Identify specific areas of conflict", priority: "high" },
                        { action: "Schedule mediation meeting with stakeholders", priority: "high" },
                        { action: "Create conflict resolution framework", priority: "medium" },
                        { action: "Implement regular check-ins to prevent future conflicts", priority: "low" }
                    ],
                    "values-alignment": [
                        { action: "Conduct values alignment assessment", priority: "medium" },
                        { action: "Review company values with client", priority: "medium" },
                        { action: "Identify areas of misalignment", priority: "high" },
                        { action: "Create values-based service adjustments", priority: "medium" }
                    ],
                    "communication": [
                        { action: "Assess current communication effectiveness", priority: "high" },
                        { action: "Provide soft skills training to team", priority: "medium" },
                        { action: "Implement coaching sessions for key team members", priority: "medium" },
                        { action: "Create communication guidelines and protocols", priority: "low" }
                    ]
                }
            },
            product: {
                name: "Product Related Issues",
                icon: "üé¨",
                subcategories: {
                    "video-mistakes": "Video Mistakes (External Look, Wrong B-Rolls, QC Mistakes)",
                    "briefs": "Briefs",
                    "results": "Results (Client Performance)"
                },
                recommendations: {
                    "video-mistakes": [
                        { action: "Conduct thorough review of recent video deliverables", priority: "high" },
                        { action: "Implement enhanced QC procedures for videos", priority: "high" },
                        { action: "Retrain editing team on client brand guidelines", priority: "medium" },
                        { action: "Create video quality checklist", priority: "medium" }
                    ],
                    "briefs": [
                        { action: "Review brief creation and approval process", priority: "high" },
                        { action: "Improve brief template with more specific requirements", priority: "medium" },
                        { action: "Implement brief review meetings with client", priority: "medium" },
                        { action: "Create brief quality scoring system", priority: "low" }
                    ],
                    "results": [
                        { action: "Analyze client performance metrics in detail", priority: "high" },
                        { action: "Identify specific areas of underperformance", priority: "high" },
                        { action: "Create performance improvement plan", priority: "medium" },
                        { action: "Schedule weekly performance review meetings", priority: "medium" }
                    ]
                }
            }
        };

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // RCA Category Selection
        function selectRCACategory(categoryKey) {
            selectedCategory = categoryKey;
            
            // Update visual selection
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // Show subcategory selection
            const categoryInfo = document.getElementById('selectedCategoryInfo');
            const categoryNameSpan = document.getElementById('selectedCategoryName');
            const subcategorySelect = document.getElementById('subcategorySelect');

            categoryNameSpan.textContent = rcaCategories[categoryKey].name;
            categoryInfo.style.display = 'block';

            // Populate subcategories
            subcategorySelect.innerHTML = '<option value="">Select specific issue...</option>';
            const subcategories = rcaCategories[categoryKey].subcategories;
            
            Object.keys(subcategories).forEach(subKey => {
                const option = document.createElement('option');
                option.value = subKey;
                option.textContent = subcategories[subKey];
                subcategorySelect.appendChild(option);
            });

            // Hide recommendations until subcategory is selected
            document.getElementById('rcaRecommendations').style.display = 'none';
        }

        // Show RCA Recommendations
        function showRCARecommendations() {
            const subcategorySelect = document.getElementById('subcategorySelect');
            selectedSubcategory = subcategorySelect.value;

            if (!selectedCategory || !selectedSubcategory) {
                document.getElementById('rcaRecommendations').style.display = 'none';
                return;
            }

            const category = rcaCategories[selectedCategory];
            const recommendations = category.recommendations[selectedSubcategory] || [];

            const recommendationsDiv = document.getElementById('rcaRecommendations');
            const categorySpan = document.getElementById('rcaCategory');
            const actionsDiv = document.getElementById('rcaActionRecommendations');

            categorySpan.textContent = category.subcategories[selectedSubcategory];
            
            actionsDiv.innerHTML = '';
            recommendations.forEach(rec => {
                const actionDiv = document.createElement('div');
                actionDiv.className = 'action-recommendation';
                actionDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>‚úì ${rec.action}</span>
                        <span class="priority-badge priority-${rec.priority}">${rec.priority.toUpperCase()}</span>
                    </div>
                `;
                actionsDiv.appendChild(actionDiv);
            });

            recommendationsDiv.style.display = 'block';
        }

        // Save RCA Findings
        async function saveRCAFindings() {
            if (!selectedCategory || !selectedSubcategory) {
                showNotification('Please select a category and subcategory first', 'error');
                return;
            }

            const description = document.getElementById('issueDescription').value;
            const factors = document.getElementById('contributingFactors').value;
            const actionPlan = document.getElementById('rcaActionPlan').value;
            const priority = document.getElementById('rcaPriority').value;

            if (!description) {
                showNotification('Please provide an issue description', 'error');
                return;
            }

            const category = rcaCategories[selectedCategory];
            const rcaData = {
                category: selectedCategory,
                subcategory: selectedSubcategory,
                categoryName: category.name,
                subcategoryName: category.subcategories[selectedSubcategory],
                description,
                factors,
                actionPlan,
                priority,
                status: 'open',
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                recommendations: category.recommendations[selectedSubcategory] || []
            };

            try {
                updateSyncStatus('syncing');
                
                // Save to Firebase
                const newRcaRef = rcaRef.push();
                await newRcaRef.set(rcaData);

                showNotification('RCA findings saved and synced across all devices!');
                
                // Clear form
                document.getElementById('issueDescription').value = '';
                document.getElementById('contributingFactors').value = '';
                document.getElementById('rcaActionPlan').value = '';
                
                // Reset selections
                document.querySelectorAll('.category-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.getElementById('selectedCategoryInfo').style.display = 'none';
                document.getElementById('rcaRecommendations').style.display = 'none';
                selectedCategory = null;
                selectedSubcategory = null;

                updateSyncStatus('online');
                
                // Switch to action plan tab to show the new RCA
                showTab('action-plan');
                document.querySelector('[onclick="showTab(\'action-plan\')"]').classList.add('active');
                document.querySelector('[onclick="showTab(\'rca\')"]').classList.remove('active');

            } catch (error) {
                showNotification('Error saving RCA: ' + error.message, 'error');
                updateSyncStatus('online');
            }
        }

        // Load RCA Findings from Firebase
        function loadRCAFindings() {
            if (rcaListener) {
                rcaListener.off();
            }

            updateSyncStatus('syncing');
            
            rcaListener = rcaRef.on('value', (snapshot) => {
                const data = snapshot.val() || {};
                rcaFindings = Object.keys(data).map(id => ({ id, ...data[id] }));
                
                // Sort by timestamp (most recent first)
                rcaFindings.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                updateActionPlansDisplay();
                updateRCATracking();
                updateSyncStatus('online');
            }, (error) => {
                showNotification('Error loading RCA data: ' + error.message, 'error');
                updateSyncStatus('offline');
            });
        }

        // Update Action Plans Display
        function updateActionPlansDisplay() {
            const actionPlanContainer = document.getElementById('actionPlanContainer');
            
            if (rcaFindings.length === 0) {
                actionPlanContainer.innerHTML = '<p>Complete an RCA analysis to generate specific action plans.</p>';
                return;
            }

            actionPlanContainer.innerHTML = '';
            
            rcaFindings.forEach(rcaData => {
                const planDiv = document.createElement('div');
                planDiv.className = 'card';
                planDiv.style.marginBottom = '20px';
                
                const timestamp = rcaData.timestamp ? 
                    new Date(rcaData.timestamp).toLocaleString() : 
                    'Recent';
                
                planDiv.innerHTML = `
                    <div class="card-header" style="background: linear-gradient(135deg, ${getPriorityColor(rcaData.priority)} 0%, ${getPriorityColor(rcaData.priority, true)} 100%);">
                        ${rcaCategories[rcaData.category]?.icon || 'üîç'} ${rcaData.categoryName} - ${rcaData.subcategoryName}
                        <span class="priority-badge priority-${rcaData.priority}" style="float: right;">${rcaData.priority.toUpperCase()}</span>
                    </div>
                    <div class="card-body">
                        <div style="margin-bottom: 10px; font-size: 0.9rem; color: #666;">
                            Created: ${timestamp}
                        </div>
                        <div style="margin-bottom: 15px;">
                            <strong>Issue:</strong> ${rcaData.description}
                        </div>
                        ${rcaData.factors ? `<div style="margin-bottom: 15px;"><strong>Contributing Factors:</strong> ${rcaData.factors}</div>` : ''}
                        ${rcaData.actionPlan ? `<div style="margin-bottom: 15px;"><strong>Custom Action Plan:</strong> ${rcaData.actionPlan}</div>` : ''}
                        
                        <h5 style="margin-top: 20px; margin-bottom: 15px;">Recommended Actions:</h5>
                        <div id="actions-${rcaData.id}">
                            ${(rcaData.recommendations || []).map((rec, index) => `
                                <div class="action-recommendation" style="margin-bottom: 10px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span>
                                            <input type="checkbox" id="action-${rcaData.id}-${index}" style="margin-right: 10px;" onchange="updateActionStatus('${rcaData.id}', ${index})">
                                            ${rec.action}
                                        </span>
                                        <span class="priority-badge priority-${rec.priority}">${rec.priority.toUpperCase()}</span>
                                    </div>
                                    <div style="margin-top: 5px; font-size: 0.9rem; color: #666;">
                                        Due: ${getActionDueDate(rec.priority)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-success" onclick="markRCAComplete('${rcaData.id}')">Mark RCA Complete</button>
                            <button class="btn btn-primary" onclick="addRCAUpdate('${rcaData.id}')">Add Progress Update</button>
                            <button class="btn btn-danger" onclick="deleteRCA('${rcaData.id}')" style="font-size: 0.9rem;">Delete RCA</button>
                        </div>
                        
                        ${rcaData.updates && rcaData.updates.length > 0 ? `
                            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                                <h6>Progress Updates:</h6>
                                ${rcaData.updates.slice(-3).map(update => `
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin: 5px 0;">
                                        <strong>${new Date(update.date).toLocaleDateString()}:</strong> ${update.update}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
                
                actionPlanContainer.appendChild(planDiv);
            });
        }

        // Update Action Status
        async function updateActionStatus(rcaId, actionIndex) {
            try {
                updateSyncStatus('syncing');
                const checkbox = document.getElementById(`action-${rcaId}-${actionIndex}`);
                const completed = checkbox.checked;
                
                await rcaRef.child(rcaId).child('actionStatus').child(actionIndex.toString()).set({
                    completed: completed,
                    completedDate: completed ? firebase.database.ServerValue.TIMESTAMP : null
                });
                
                showNotification(completed ? 'Action marked as complete!' : 'Action marked as pending');
                updateSyncStatus('online');
            } catch (error) {
                showNotification('Error updating action status: ' + error.message, 'error');
                updateSyncStatus('online');
            }
        }

        // Mark RCA as complete
        async function markRCAComplete(rcaId) {
            if (confirm('Mark this RCA as complete? This will close the follow-up tracking.')) {
                try {
                    updateSyncStatus('syncing');
                    await rcaRef.child(rcaId).update({
                        status: 'completed',
                        completedDate: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    showNotification('RCA marked as complete and synced!');
                    updateSyncStatus('online');
                } catch (error) {
                    showNotification('Error updating RCA: ' + error.message, 'error');
                    updateSyncStatus('online');
                }
            }
        }

        // Add RCA update
        async function addRCAUpdate(rcaId) {
            const update = prompt('Enter progress update:');
            if (!update) return;

            try {
                updateSyncStatus('syncing');
                const updatesRef = rcaRef.child(rcaId).child('updates');
                const newUpdateRef = updatesRef.push();
                
                await newUpdateRef.set({
                    date: firebase.database.ServerValue.TIMESTAMP,
                    update: update
                });
                
                showNotification('Progress update added and synced!');
                updateSyncStatus('online');
            } catch (error) {
                showNotification('Error adding update: ' + error.message, 'error');
                updateSyncStatus('online');
            }
        }

        // Delete RCA
        async function deleteRCA(rcaId) {
            if (confirm('Are you sure you want to delete this RCA? This action cannot be undone.')) {
                try {
                    updateSyncStatus('syncing');
                    await rcaRef.child(rcaId).remove();
                    showNotification('RCA deleted and synced across all devices');
                    updateSyncStatus('online');
                } catch (error) {
                    showNotification('Error deleting RCA: ' + error.message, 'error');
                    updateSyncStatus('online');
                }
            }
        }

        // Helper function to get priority colors
        function getPriorityColor(priority, lighter = false) {
            const colors = {
                high: lighter ? '#ff6b6b' : '#ff4b2b',
                medium: lighter ? '#ffd93d' : '#ffa500',
                low: lighter ? '#6bcf7f' : '#28a745'
            };
            return colors[priority] || colors.medium;
        }

        // Helper function to calculate due dates
        function getActionDueDate(priority) {
            const now = new Date();
            const daysToAdd = {
                high: 2,
                medium: 7,
                low: 14
            };
            
            const dueDate = new Date(now);
            dueDate.setDate(now.getDate() + daysToAdd[priority]);
            
            return dueDate.toLocaleDateString();
        }

        // Mark RCA as complete
        function markRCAComplete(rcaId) {
            if (confirm('Mark this RCA as complete? This will close the follow-up tracking.')) {
                const rca = rcaFindings.find(r => r.id === rcaId);
                if (rca) {
                    rca.status = 'completed';
                    rca.completedDate = new Date();
                    showNotification('RCA marked as complete!');
                    updateRCATracking();
                }
            }
        }

        // Add RCA update
        function addRCAUpdate(rcaId) {
            const update = prompt('Enter progress update:');
            if (!update) return;

            const rca = rcaFindings.find(r => r.id === rcaId);
            if (rca) {
                if (!rca.updates) rca.updates = [];
                rca.updates.push({
                    date: new Date(),
                    update: update
                });
                showNotification('Progress update added!');
                updateRCATracking();
            }
        }

        // Update Sync Status
        function updateSyncStatus(status) {
            const syncText = document.getElementById('syncText');
            const syncStatus = document.getElementById('syncStatus');
            
            syncStatus.className = `sync-status sync-${status}`;
            
            switch(status) {
                case 'online':
                    syncText.textContent = '‚úÖ Real-time Synced';
                    break;
                case 'offline':
                    syncText.textContent = '‚ùå Offline';
                    break;
                case 'syncing':
                    syncText.textContent = 'üîÑ Syncing...';
                    break;
            }
        }

        // Update RCA Tracking
        function updateRCATracking() {
            const trackingContainer = document.getElementById('rcaTrackingList');
            const openRCAs = rcaFindings.filter(rca => rca.status === 'open');
            
            if (openRCAs.length === 0) {
                trackingContainer.innerHTML = '<p>No active RCA items to track. All issues have been resolved! üéâ</p>';
                return;
            }

            trackingContainer.innerHTML = '';
            
            // Sort by priority and date
            openRCAs.sort((a, b) => {
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                return (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0);
            });

            openRCAs.forEach(rca => {
                const trackingCard = document.createElement('div');
                trackingCard.className = 'card';
                trackingCard.style.marginBottom = '15px';
                
                const daysSinceCreated = Math.floor((new Date() - rca.timestamp) / (1000 * 60 * 60 * 24));
                
                trackingCard.innerHTML = `
                    <div class="card-header" style="background: linear-gradient(135deg, ${getPriorityColor(rca.priority)} 0%, ${getPriorityColor(rca.priority, true)} 100%);">
                        ${rcaCategories[rca.category].icon} ${rca.categoryName} - ${rca.subcategoryName}
                        <span style="float: right; font-size: 0.9rem;">Created ${daysSinceCreated} days ago</span>
                    </div>
                    <div class="card-body" style="padding: 15px;">
                        <div style="margin-bottom: 10px;">
                            <strong>Issue:</strong> ${rca.description}
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Priority:</strong> <span class="priority-badge priority-${rca.priority}">${rca.priority.toUpperCase()}</span>
                        </div>
                        ${rca.updates && rca.updates.length > 0 ? `
                            <div style="margin-bottom: 10px;">
                                <strong>Latest Update:</strong> ${rca.updates[rca.updates.length - 1].update}
                                <small style="color: #666;"> (${rca.updates[rca.updates.length - 1].date.toLocaleDateString()})</small>
                            </div>
                        ` : ''}
                        
                        <div style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="markRCAComplete('${rca.id}')" style="font-size: 0.9rem; padding: 8px 16px;">Mark Complete</button>
                            <button class="btn btn-primary" onclick="addRCAUpdate('${rca.id}')" style="font-size: 0.9rem; padding: 8px 16px;">Add Update</button>
                        </div>
                    </div>
                `;
                
                trackingContainer.appendChild(trackingCard);
            });

            // Add summary stats
            const statsDiv = document.createElement('div');
            statsDiv.className = 'card';
            statsDiv.innerHTML = `
                <div class="card-header">üìä RCA Summary</div>
                <div class="card-body" style="display: flex; justify-content: space-around; text-align: center;">
                    <div>
                        <div style="font-size: 2rem; font-weight: bold; color: #ff4b2b;">${openRCAs.filter(r => r.priority === 'high').length}</div>
                        <div>High Priority</div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: bold; color: #ffa500;">${openRCAs.filter(r => r.priority === 'medium').length}</div>
                        <div>Medium Priority</div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: bold; color: #28a745;">${openRCAs.filter(r => r.priority === 'low').length}</div>
                        <div>Low Priority</div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: bold; color: #667eea;">${rcaFindings.filter(r => r.status === 'completed').length}</div>
                        <div>Completed</div>
                    </div>
                </div>
            `;
            
            trackingContainer.appendChild(statsDiv);
        }

        // Utility Functions
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notificationToast');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.style.display = 'block';
            
            if (type === 'error') {
                notification.style.background = '#dc3545';
            } else {
                notification.style.background = '#28a745';
            }
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadRCAFindings();
            showNotification('RCA Dashboard loaded with real-time sync!');
        });

        // Handle connection status
        window.addEventListener('online', () => {
            updateSyncStatus('online');
            showNotification('Connection restored - real-time sync active!');
            if (!rcaListener) {
                loadRCAFindings();
            }
        });

        window.addEventListener('offline', () => {
            updateSyncStatus('offline');
            showNotification('Connection lost - working offline', 'error');
        });

        // Database connection monitoring
        const connectedRef = database.ref('.info/connected');
        connectedRef.on('value', (snapshot) => {
            if (snapshot.val() === true) {
                updateSyncStatus('online');
            } else {
                updateSyncStatus('offline');
            }
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
